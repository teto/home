Lists compilation directives to load different ntp programs in DCE/ns3.


ns3 & DCE clock testing
===
To run the ns3 testsuite related to per-node clocks:
ns3off$ ./test.py -sclock
-snode-scheduling

To run the DCE tests:
ns3testing$ ./test_ns3.py --load-log ns_clock.txt example dce-ntpd --out=toto.log 



Ntimed 
===
Pour le compiler

https://github.com/bsdphk/Ntimed or 
https://github.com/teto/Ntimed on branch "freestyle" (ex-"add_ldflags")

$ sh ./configure
$ CFLAGS="-fPIC -U_FORTIFY_SOURCE " LDFLAGS="-pie -rdynamic -ggdb" make

./ntimed-client --poll-server 1.ubuntu.pool.ntp.org
The '-t /tmp/somefile' arguments tells it to write a full blow-by-blow
tracefile, for analysis and debugging.

ntpq -p ntp.lip6.fr
osiris.lip6.fr

readelf -h ntimed-client |grep Type  (t'attends 'DYN' comme output)

Ntimed exporte les stats dans un fichier via des Put dans le contexte opérationnel OCX_TRACE.


NTP_PeerSet a l'air intéressant

 TB_Step() and TB_Adjust()


Format de la sortie:
Poll [hostname] [ip] [generated by NTP_Tool_Format]: ie:
[leap version mode stratum poll precision delay dispersion refid diffReferenceOrigin origin diffRcvOrigin diffTransmitRecv diffRxTransmit]
Poll 10.1.1.2 10.1.1.2 [0 4 4  10   4  -20 0.000000000 0.000000000 0x7f7f0101 -0.998874081 1262304000.700004000 0.001125919 0.000002055 0.001126027]
Now 1262304001.700003000 NTP_PeerSet


=== NTP packet format ===
page 237:

Reference Timestamp. This is the local time at which the system clock was last set or corrected, in 64-bit NTP timestamp format.
• Originate Timestamp. This is the local time at which the request departed the client for the server, in 64-bit NTP timestamp format.
• Receive Timestamp. This is the local time at which the request arrived at the server, in 64-bit NTP timestamp format.
• Transmit Timestamp. This is the local time at which the reply departed the servers for the client, in 64-bit NTP timestamp format.

OPENNTPD portable 
===

git@github.com:openntpd-portable/openntpd-portable.git
$ ./autogen.sh
(This pulls some BSD code that for now fails on my machine)
CFLAGS="-fPIC -U_FORTIFY_SOURCE -g" LDFLAGS="-pie -rdynamic" ./configure


Chrony 
===

On linux relies exclusively on adjtimex.

git://git.tuxfamily.org/gitroot/chrony/chrony.git

Compilation:
CFLAGS="-fPIC -U_FORTIFY_SOURCE -g" LDFLAGS="-pie -rdynamic" ./configure --enable-debug --disable-phc --without-tomcrypt --without-nss --disable-sechash --disable-linuxcaps --disable-asyncdns --disable-forcednsretry
then make

Configuration commands listed here:
http://chrony.tuxfamily.org/manual.html#Configuration-file

transmit_packet va chercher le root_delay dans REF_GetReferenceParams
our_root_delay est initialisé à 1 et est in

NTPd 
===

$ git clone coudron@forge.lip6.fr:ntp branch "freestyle"


Lancer le configure comme:
$ CFLAGS="-fPIC -U_FORTIFY_SOURCE -ggdb" LDFLAGS="-pie -rdynamic" ./configure --enable-debugging  --enable-getifaddrs --enable-thread-support=no --without-sntp

If you set --enable-getifaddrs=no then you resort to ioctl (SIOCGIFCONF) which seems broken on linux

In stock dce getifaddr seems to have a bug

You may need to add --with-openssl-libdir=/usr/lib/x86_64-linux-gnu

  --enable-getifaddrs     + Enable the use of getifaddrs() [[yes|no]].
  --enable-slew-always    s always slew the time
  --enable-step-slew      s step and slew the time
  --enable-ntpdate-step   s if ntpdate should step the time

Dans measure_tick_fuzz, ntp essaye de voir quelle est la précision max de l'horlge en mesurant rapidement 
// 20e-9	== minimum clock increment (s)

To add debug statements in "isc" folder, use "isc_log_write"
To add debug statements in "ntpd" folder, use "msyslog" I think


NTPd debugging guide 
===
First start ntpd locally
sudo ntpd -c ~/dotfiles/ntp.conf -l ntp.log -p ntp.pid -f ntp.drift -n -D 1
ntpq --numeric --peers
ntpq -p will display the offsets for each reachable server in milliseconds (ntpdc -p uses seconds instead)

 
./ntimed-client -t ntimed.log 127.0.0.1

# -4 accepts only ipv4 "-d" appears twice to prevent fork and display debug message (ensure +DEBUG)
sudo ~/chrony/chronyd -f ~/dce/myscripts/ntp/chrony.conf -d -d -4
